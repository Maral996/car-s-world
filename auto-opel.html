<!DOCTYPE html>
<html lang="it">

<head>
    <script id="Cookiebot" src="https://consent.cookiebot.com/uc.js" data-cbid="5d23d7d2-db15-446e-8c3f-297de6dfca55" data-blockingmode="auto" type="text/javascript"></script>

    <script type="text/javascript">
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('consent', 'default', {
            'ad_storage': 'denied',
            'analytics_storage': 'denied',
            'ad_user_data': 'denied',
            'ad_personalization': 'denied',
            'wait_for_update': 500
        });
    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HCL5TVJMD5" type="text/plain" data-cookieconsent="statistics"></script>
    <script type="text/plain" data-cookieconsent="statistics">
        gtag('js', new Date());
        gtag('config', 'G-HCL5TVJMD5');
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Store Ricambi - Car's world</title>
    <link rel="canonical" href="https://www.carsworld.it/store.html" />
    <style>
        /* RESET E BLOCCO SCIVOLAMENTO/ZOOM */
        * { box-sizing: border-box !important; touch-action: manipulation; }
        html, body { overflow-x: hidden !important; width: 100%; margin: 0; padding: 0; position: relative; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding-top: 90px; }
        
        header { position: fixed; top: 0; left: 0; right: 0; height: 75px; background: #ff9800; color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 10000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .brand-box { display: flex; flex-direction: column; align-items: flex-start; }
        header h1 { font-size: 19px; text-transform: uppercase; margin: 0; line-height: 1.1; }
        .sub-title { font-size: 14px; font-weight: bold; text-transform: uppercase; opacity: 0.9; margin-top: 2px; }
        .btn-apri-carrello { background: white; color: #ff9800; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; min-width: 100px; justify-content: center; }
        
        .container { max-width: 650px; margin: auto; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        #search-ricambi { width: 100%; max-width: 500px; padding: 15px; border-radius: 12px; border: 2px solid #ff9800; margin-bottom: 20px; outline: none; font-size: 16px; }

        /* CARD PRODOTTO */
        .product-card { background: white; width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; }
        .product-img { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; background: #eee; cursor: zoom-in; }
        .product-img[src=""], .product-img:not([src]) { display: none !important; } 
        
        .product-info { flex-grow: 1; text-align: left; }
        .product-info h4 { margin: 0; color: #1a73e8; font-size: 17px; cursor: pointer; text-decoration: underline; }
        .right-side { text-align: right; min-width: 120px; }
        .price { font-weight: bold; color: #ff9800; font-size: 18px; margin-bottom: 5px; }

        /* SELETTORE QUANTIT√Ä */
        .qty-controls { display: flex; align-items: center; justify-content: flex-end; gap: 10px; margin-top: 5px; }
        .btn-qty { background: #eee; border: none; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .qty-val { font-weight: bold; font-size: 16px; min-width: 20px; text-align: center; }
        .btn-add { background: #4caf50; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 11px; text-transform: uppercase; width: 100%; }

        /* MODAL E OVERLAY */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 30000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 15px; padding: 20px; position: relative; text-align: center; }
        .modal-img { width: 100%; max-height: 250px; object-fit: contain; border-radius: 10px; margin-bottom: 15px; cursor: zoom-in; display: block; margin-left: auto; margin-right: auto; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 25px; cursor: pointer; color: #666; }

        /* ZOOM IMMAGINE */
        #zoom-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 40000; display: none; align-items: center; justify-content: center; cursor: zoom-out; }
        #zoom-overlay img { max-width: 95%; max-height: 95%; border-radius: 5px; }

        /* CARRELLO */
        #overlay-carrello { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f2f5; z-index: 20000; overflow-y: auto; display: none; }
        .carrello-content { max-width: 600px; margin: 0 auto; padding: 0 20px 20px 20px; }
        
        .header-carrello-fisso { position: sticky; top: 0; background: #f0f2f5; z-index: 21000; padding: 20px 0 15px 0; border-bottom: 2px solid #ff9800; margin-bottom: 20px; text-align: center; }
        .header-carrello-fisso h2 { margin: 0 0 10px 0; color: #333; font-size: 22px; }
        .btn-continua { background: #ff9800; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; width: 100%; max-width: 300px; }
        
        .carrello-item { background: white; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); gap: 10px; }
        .cart-thumb { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; background: #eee; flex-shrink: 0; cursor: zoom-in; }

        .mini-riepilogo-ricambi { background: #e3f2fd; padding: 12px 15px; border-radius: 8px; margin: 10px 0 20px 0; display: flex; justify-content: space-between; align-items: center; border: 1px dashed #1e88e5; }

        /* FORM CARRELLO */
        .sezione-form { background: white; padding: 20px; border-radius: 12px; margin-top: 20px; text-align: left; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: background 0.3s ease; }
        .sezione-form h3 { margin-top: 0; color: #ff9800; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 15px; }
        .riepilogo-finale-box { background: #fff3e0; padding: 20px; border-radius: 12px; border: 2px solid #ff9800; margin: 20px 0; text-align: right; line-height: 1.6; }
        .riepilogo-linea { display: flex; justify-content: space-between; font-size: 15px; border-bottom: 1px solid #ffe0b2; padding: 4px 0; }
        
        .sezione-disabled { background: #f0f0f0 !important; }
        .sezione-disabled textarea { background: #e9e9e9; color: #777; cursor: not-allowed; }

        .hidden { display: none !important; }

        .preventivo-rapido { background: #333; color: white; width: 100%; max-width: 500px; padding: 20px; border-radius: 15px; margin-top: 40px; margin-bottom: 30px; box-sizing: border-box; text-align: left; }
        .preventivo-rapido h3 { margin-top: 0; color: #ff9800; }
        .preventivo-rapido p { font-size: 13px; color: #ccc; margin-bottom: 15px; }

        footer { background: #333; color: white; padding: 40px 20px; margin-top: 50px; text-align: center; font-size: 14px; width: 100%; box-sizing: border-box; }
        .footer-container { max-width: 650px; margin: auto; text-align: left; }
        
        .btn-invia { background: #ff9800; color: white; padding: 18px; width: 100%; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 16px; margin-top: 10px; box-shadow: 0 4px 15px rgba(255,152,0,0.3); }
        .totale-grande { font-size: 24px; font-weight: bold; color: #e65100; text-align: right; border-top: 2px solid #ff9800; margin-top: 10px; padding-top: 5px; }

        /* MODALE PDF */
        #modal-pdf { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 50000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .pdf-actions { background: white; padding: 15px; border-radius: 12px; display: flex; gap: 10px; margin-bottom: 10px; width: 95%; max-width: 750px; justify-content: center; flex-wrap: wrap; }
        .btn-pdf { border: none; padding: 12px 18px; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; gap: 5px; font-size: 13px; }
        #pdf-preview { width: 95%; height: 75vh; max-width: 800px; background: white; border-radius: 8px; border: none; }

        /* LOGICA NASCONDERE DOWNLOAD SU MOBILE */
        @media (max-width: 768px) {
            .btn-download-pdf { display: none !important; }
        }
    </style>
</head>

<body>

    <header>
        <div class="brand-box">
            <h1>Car's World</h1>
            <span class="sub-title">Store</span>
        </div>
        <button class="btn-apri-carrello" onclick="toggleCarrello(true)">
            üõí <span id="label-cart">CARRELLO</span> (<span id="count-cart">0</span>)
        </button>
    </header>

    <div class="container">
        <input type="text" id="search-ricambi" placeholder="üîç Cerca tra i ricambi" onkeyup="filterProducts()">

        <div id="lista-prodotti" style="width: 100%;">
            <div class="product-card" data-id="1">
                <img src="img/spazzole.jpg" class="product-img" onclick="zoomImg(this.src)" onerror="this.style.display='none'">
                <div class="product-info">
                    <h4 onclick="openDetails(1)">Spazzole Tergicristallo</h4>
                    <p style="margin:2px 0; font-size:12px; color:#888;">Coppia di spazzole anteriori ad alta visibilit√†...</p>
                </div>
                <div class="right-side">
                    <div class="price">30.00‚Ç¨</div>
                    <div id="ctrl-1"></div>
                </div>
            </div>
             
            <div class="product-card" data-id="2">
                <img src="img/batteria.jpg" class="product-img" onclick="zoomImg(this.src)" onerror="this.style.display='none'">
                <div class="product-info">
                    <h4 onclick="openDetails(2)">Batteria 60Ah</h4>
                    <p style="margin:2px 0; font-size:12px; color:#888;">Batteria 12V 60Ah con spunto maggiorato...</p>
                </div>
                <div class="right-side">
                    <div class="price">75.00‚Ç¨</div>
                    <div id="ctrl-2"></div>
                </div>
            </div>

            <div class="product-card" data-id="3">
                <img src="img/lampadinah7bosch.jpg" class="product-img" onclick="zoomImg(this.src)" onerror="this.style.display='none'">
                <div class="product-info">
                    <h4 onclick="openDetails(3)">Lampadina Bosch H7</h4>
                    <p style="margin:2px 0; font-size:12px; color:#888;">Lampadina H7 - 55W - 12V - 5000K...</p>
                </div>
                <div class="right-side">
                    <div class="price">12.00‚Ç¨</div>
                    <div id="ctrl-3"></div>
                </div>
            </div>
        </div>

        <div class="preventivo-rapido">
            <h3>Non trovi il tuo ricambio?</h3>
            <p>Inviaci i dati e ti risponderemo con un preventivo personalizzato.</p>
            <form id="form-preventivo" action="https://formspree.io/f/mlgdkage" method="POST">
                <input type="text" name="nome_contatto" placeholder="Il tuo Nome" required>
                <select name="preferenza_contatto" required>
                    <option value="" disabled selected>Come vuoi essere contattato?</option>
                    <option value="WhatsApp">WhatsApp</option>
                    <option value="Email">E-mail</option>
                </select>
                <input type="text" name="recapito" placeholder="Inserisci Numero o Email" required>
                <input type="text" name="targa_richiesta" placeholder="Targa del veicolo" required>
                <textarea name="ricambio_cercato" placeholder="Quale ricambio stai cercando?" style="height: 80px;" required></textarea>
                <button type="submit" class="btn-invia" style="padding: 12px; font-size: 14px;">Richiedi Preventivo</button>
            </form>
        </div>
        <a href="index.html" style="margin:20px 0; text-decoration:none; color:#666; font-weight:bold;">‚Üê Torna a Car's world</a>
    </div>

    <div id="modal-details" class="modal-overlay" onclick="closeDetails()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-modal" onclick="closeDetails()">√ó</span>
            <img id="m-img" src="" class="modal-img" onclick="zoomImg(this.src)" onerror="this.style.display='none'">
            <h2 id="m-titolo" style="color:#333; margin:10px 0;"></h2>
            <p id="m-desc" style="color:#666; font-size:14px; line-height:1.5; padding:0 10px;"></p>
            <div id="m-price" class="price" style="font-size:22px; margin:15px 0;"></div>
            <div id="m-ctrl" style="max-width:200px; margin:auto;"></div>
        </div>
    </div>

    <div id="zoom-overlay" onclick="this.style.display='none'">
        <img id="zoom-img" src="">
    </div>

    <div id="overlay-carrello">
        <div class="header-carrello-fisso">
            <h2>Riepilogo Ordine</h2>
            <button class="btn-continua" onclick="toggleCarrello(false)">‚Üê Continua lo shopping</button>
        </div>
        <div class="carrello-content">
            <div id="lista-carrello-full"></div>
            <div id="mini-box-ricambi" class="hidden">
                <div class="mini-riepilogo-ricambi">
                    <span>Totale Ricambi: <strong><span id="mini-tot-prezzo">0.00</span>‚Ç¨</strong></span>
                    <button onclick="svuotaCarrello(true)" style="background:#d32f2f; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:12px;">üóë Svuota</button>
                </div>
            </div>
            <div id="modulo-completo" class="hidden">
                <form id="form-carrello" action="https://formspree.io/f/mlgdkage" method="POST" onsubmit="return gestisciInvioOrdine(event)">
                    <div class="sezione-form">
                        <h3>1. Dati Fatturazione</h3>
                        <select name="tipo_cliente" id="tipo_cliente" onchange="switchFatt()">
                            <option value="Privato">Privato</option>
                            <option value="Azienda">Azienda</option>
                        </select>
                        <div id="box-privato">
                            <input type="text" name="nome" placeholder="Nome e Cognome" required>
                            <input type="text" name="cf" placeholder="Codice Fiscale" required>
                        </div>
                        <div id="box-ditta" class="hidden">
                            <input type="text" name="ragione_sociale" placeholder="Ragione Sociale">
                            <input type="text" name="piva" placeholder="Partita IVA">
                            <input type="text" name="codice_univoco" id="cod_univoco" placeholder="Codice Univoco o PEC">
                        </div>
                        <textarea name="ind_fatturazione" id="ind_fatt" placeholder="Indirizzo" required onkeyup="syncSped()"></textarea>
                    </div>
                    <div class="sezione-form" id="sez_spedizione">
                        <h3>2. Spedizione e Contatti</h3>
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                            <input type="checkbox" id="check_uguale" onclick="syncSped()" style="width:auto; margin:0;">
                            <label for="check_uguale" style="font-size:14px;">Spedizione uguale alla fatturazione</label>
                        </div>
                        <textarea name="ind_spedizione" id="ind_sped" placeholder="Indirizzo di spedizione" required></textarea>
                        <input type="tel" name="telefono" placeholder="Cellulare per il corriere (Facoltativo)">
                    </div>
                    <div class="sezione-form">
                        <h3>3. Metodo di Pagamento</h3>
                        <select name="pagamento" id="metodo_pag" onchange="renderCart()">
                            <option value="Bonifico">Bonifico Bancario</option>
                            <option value="Contrassegno">Contrassegno (+5.00‚Ç¨)</option>
                        </select>
                    </div>
                    <div class="riepilogo-finale-box">
                        <div class="riepilogo-linea"><span>Ricambi:</span> <span id="res-ricambi">0.00‚Ç¨</span></div>
                        <div class="riepilogo-linea"><span>Spedizione:</span> <span id="res-spedizione">0.00‚Ç¨</span></div>
                        <div id="riga-contrassegno" class="riepilogo-linea hidden"><span>Contrassegno:</span> <span>5.00‚Ç¨</span></div>
                        <div class="totale-grande">TOTALE: <span id="res-totale">0.00</span>‚Ç¨</div>
                    </div>
                    <input type="hidden" name="ordine_dettagliato" id="hidden_ordine">
                    <input type="hidden" name="numero_ordine_generato" id="hidden_num_ordine">
                    <button type="submit" class="btn-invia">Visualizza Ordine</button>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-pdf">
        <div class="pdf-actions">
            <button class="btn-pdf" style="background:#6c757d;" onclick="modificaOrdine()">‚úèÔ∏è INDIETRO</button>
            <button class="btn-pdf btn-download-pdf" style="background:#28a745;" onclick="downloadPDF()">üíæ Download</button>
            <button class="btn-pdf" style="background:#007bff;" onclick="condividiPDF()">üì≤ Condividi</button>
            <button class="btn-pdf" style="background:#ff9800;" onclick="chiudiEInvia()">üöÄ INVIA ORDINE</button>
        </div>
        <iframe id="pdf-preview"></iframe>
    </div>

    <footer>
        <div class="footer-container">
            <h3 style="color: #ff9800; margin-top: 0;">Car's World - Store Online</h3>
            <p><strong>Assistenza Clienti:</strong> Specialisti in Ricambi Auto - Vendita e Consulenza Tecnica Online</p>
            <hr style="border: 0; border-top: 1px solid #555; margin: 20px 0;">
            <p><strong>Cosa devi sapere:</strong></p>
            <ul style="list-style-type: none; padding: 0; line-height: 1.6; color: #bbb;">
                <li>üöö <strong>Spedizioni:</strong> 7,50‚Ç¨ (Gratis per ordini sopra i 100‚Ç¨).</li>
                <li>üì¶ <strong>Resi:</strong> Diritto di recesso entro 14 giorni.</li>
                <li>üí≥ <strong>Pagamenti:</strong> Bonifico o Contrassegno (+5,00‚Ç¨).</li>
                <li>üîç <strong>Compatibilit√†:</strong> Verifica tramite targa inclusa.</li>
            </ul>
            
            <div style="margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap; border-top: 1px solid #444; padding-top: 15px;">
                <a href="javascript: Cookiebot.renew()" style="color: #bbb; text-decoration: none; font-size: 12px;">üîÑ Personalizza Cookie</a>
                <a href="https://www.carsworld.it/privacy-policy.html" target="_blank" style="color: #bbb; text-decoration: none; font-size: 12px;">üìÑ Privacy Policy</a>
                <a href="https://www.carsworld.it/cookie-policy.html" target="_blank" style="color: #bbb; text-decoration: none; font-size: 12px;">üç™ Cookie Policy</a>
            </div>

            <p style="text-align: center; color: #888; margin-top: 20px; font-size: 12px;">&copy; 2026 Car's World - Store Ricambi Online</p>
        </div>
    </footer>

    <script>
        const prodotti = {
            1: { nome: "Spazzole Tergicristallo", prezzo: 30.00, img: "img/spazzole.jpg", desc: "Coppia di spazzole anteriori ad alta visibilit√†, compatibili con attacchi originali." },
            2: { nome: "Batteria 60Ah", prezzo: 75.00, img: "img/batteria.jpg", desc: "Batteria 12V 60Ah con spunto maggiorato per partenze sicure." },
            3: { nome: "Lampadina Bosch H7", prezzo: 12.00, img: "img/lampadinah7bosch.jpg", desc: "Lampadina H7 Bosch alta luminosit√† per una guida notturna sicura." }
        };

        let cart = JSON.parse(localStorage.getItem('cart_carsworld')) || {};
        let currentDoc = null;
        let currentOrderNum = "";

        // Aggiorna la pagina quando si torna indietro dal browser (es. dopo invio Formspree)
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                window.location.reload();
            }
        });

        function generateOrderNumber() {
            const chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            let result = "";
            for (let i = 0; i < 10; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function updateQty(id, delta) {
            let current = cart[id] || 0;
            let newQty = current + delta;
            if (newQty <= 0) delete cart[id];
            else cart[id] = newQty;
            saveCart();
            renderUI();
        }

        function saveCart() { localStorage.setItem('cart_carsworld', JSON.stringify(cart)); }

        function renderUI() {
            Object.keys(prodotti).forEach(id => {
                const container = document.getElementById(`ctrl-${id}`);
                const qty = cart[id] || 0;
                if(!container) return;
                container.innerHTML = qty > 0 ? 
                    `<div class="qty-controls"><button class="btn-qty" onclick="updateQty(${id}, -1)">-</button><span class="qty-val">${qty}</span><button class="btn-qty" onclick="updateQty(${id}, 1)">+</button></div>` :
                    `<button class="btn-add" onclick="updateQty(${id}, 1)">+ Aggiungi</button>`;
            });
            const mDetails = document.getElementById('modal-details');
            if(mDetails && mDetails.dataset.currentId) updateModalQty(mDetails.dataset.currentId);
            renderCart();
        }

        function renderCart() {
            let totalRicambi = 0; let count = 0; let dettagli = "";
            const lista = document.getElementById('lista-carrello-full');
            lista.innerHTML = "";
            
            Object.keys(cart).forEach(id => {
                let p = prodotti[id]; let qty = cart[id]; let subtot = p.prezzo * qty;
                totalRicambi += subtot; count += qty; dettagli += `${p.nome} x${qty} (${subtot.toFixed(2)}‚Ç¨), `;
                lista.innerHTML += `
                    <div class="carrello-item">
                        <img src="${p.img}" class="cart-thumb" onclick="zoomImg(this.src)" onerror="this.style.display='none'">
                        <div style="flex-grow:1;"><strong>${p.nome}</strong><br><small>${qty} pz x ${p.prezzo.toFixed(2)}‚Ç¨</small></div>
                        <div class="qty-controls">
                            <button class="btn-qty" onclick="updateQty(${id}, -1)">-</button>
                            <span class="qty-val">${qty}</span>
                            <button class="btn-qty" onclick="updateQty(${id}, 1)">+</button>
                        </div>
                    </div>`;
            });

            let spedizione = (totalRicambi >= 100 || totalRicambi === 0) ? 0 : 7.50;
            let contrassegno = document.getElementById('metodo_pag').value === "Contrassegno" ? 5 : 0;
            let finale = totalRicambi + spedizione + contrassegno;

            document.getElementById('label-cart').innerText = totalRicambi > 0 ? totalRicambi.toFixed(2) + "‚Ç¨" : "CARRELLO";
            document.getElementById('count-cart').innerText = count;
            document.getElementById('res-ricambi').innerText = totalRicambi.toFixed(2) + "‚Ç¨";
            document.getElementById('res-spedizione').innerText = totalRicambi >= 100 ? "Gratis" : (totalRicambi === 0 ? "0.00‚Ç¨" : "7.50‚Ç¨");
            document.getElementById('riga-contrassegno').classList.toggle('hidden', contrassegno === 0);
            document.getElementById('res-totale').innerText = finale.toFixed(2);
            document.getElementById('mini-tot-prezzo').innerText = totalRicambi.toFixed(2);
            document.getElementById('mini-box-ricambi').classList.toggle('hidden', count === 0);
            
            document.getElementById('hidden_ordine').value = `${dettagli} | Ricambi: ${totalRicambi.toFixed(2)}‚Ç¨ | Sped: ${spedizione.toFixed(2)}‚Ç¨ | Pagamento: ${document.getElementById('metodo_pag').value} | TOTALE: ${finale.toFixed(2)}‚Ç¨`;
            document.getElementById('modulo-completo').classList.toggle('hidden', count === 0);
            if(count === 0) lista.innerHTML = "<p style='text-align:center; padding:20px; color:#999;'>Carrello vuoto</p>";
        }

        function openDetails(id) {
            const p = prodotti[id];
            const mImg = document.getElementById('m-img');
            mImg.style.display = p.img ? "block" : "none";
            mImg.src = p.img || "";
            document.getElementById('m-titolo').innerText = p.nome;
            document.getElementById('m-desc').innerText = p.desc;
            document.getElementById('m-price').innerText = p.prezzo.toFixed(2) + "‚Ç¨";
            document.getElementById('modal-details').dataset.currentId = id;
            updateModalQty(id);
            document.getElementById('modal-details').style.display = 'flex';
        }

        function updateModalQty(id) {
            const qty = cart[id] || 0;
            const container = document.getElementById('m-ctrl');
            container.innerHTML = qty > 0 ? 
                `<div class="qty-controls" style="justify-content:center;"><button class="btn-qty" onclick="updateQty(${id}, -1)">-</button><span class="qty-val" style="margin:0 15px;">${qty}</span><button class="btn-qty" onclick="updateQty(${id}, 1)">+</button></div>` :
                `<button class="btn-invia" onclick="updateQty(${id}, 1)">Aggiungi al Carrello</button>`;
        }

        function closeDetails() { document.getElementById('modal-details').style.display = 'none'; delete document.getElementById('modal-details').dataset.currentId; }
        function zoomImg(src) { if(!src) return; document.getElementById('zoom-img').src = src; document.getElementById('zoom-overlay').style.display = 'flex'; }
        function toggleCarrello(show) { document.getElementById('overlay-carrello').style.display = show ? 'block' : 'none'; }
        
        function svuotaCarrello(conferma) { 
            if(conferma && !confirm("Svuotare il carrello?")) return;
            cart = {}; saveCart(); renderUI(); 
        }
        
        function switchFatt() {
            const isDitta = document.getElementById('tipo_cliente').value === 'Azienda';
            document.getElementById('box-privato').classList.toggle('hidden', isDitta);
            document.getElementById('box-ditta').classList.toggle('hidden', !isDitta);
        }
        
        function syncSped() { 
            const checkUguale = document.getElementById('check_uguale');
            const indFatt = document.getElementById('ind_fatt');
            const indSped = document.getElementById('ind_sped');
            const sezSped = document.getElementById('sez_spedizione');
            if(checkUguale.checked) {
                indSped.value = indFatt.value;
                indSped.readOnly = true;
                sezSped.classList.add('sezione-disabled');
            } else {
                indSped.readOnly = false;
                sezSped.classList.remove('sezione-disabled');
            }
        }
        
        function filterProducts() {
            let val = document.getElementById('search-ricambi').value.toLowerCase();
            let cards = document.getElementsByClassName('product-card');
            for(let c of cards) { c.style.display = c.innerText.toLowerCase().includes(val) ? "flex" : "none"; }
        }

        let allowSubmit = false;
        function gestisciInvioOrdine(e) {
            if(allowSubmit) return true;
            e.preventDefault();
            currentOrderNum = generateOrderNumber();
            document.getElementById('hidden_num_ordine').value = currentOrderNum;
            generaPDF();
            return false;
        }

        async function generaPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const ora = new Date().toLocaleString('it-IT');
            doc.setFontSize(22); doc.setTextColor(255, 152, 0); doc.text("Car's World - Store Ricambi", 20, 20);
            doc.setFontSize(10); doc.setTextColor(100); 
            doc.text(`Ordine N: ${currentOrderNum}`, 20, 30);
            doc.text(`Data: ${ora}`, 140, 30);
            doc.line(20, 35, 190, 35);
            doc.setFontSize(14); doc.setTextColor(0); doc.text("Dati Fatturazione:", 20, 45);
            doc.setFontSize(10);
            let y = 52;
            if (document.getElementById('tipo_cliente').value === 'Azienda') {
                doc.text(`Azienda: ${document.getElementsByName('ragione_sociale')[0].value}`, 20, y); y+=5;
                doc.text(`P.IVA: ${document.getElementsByName('piva')[0].value}`, 20, y); y+=5;
                doc.text(`Cod. Univoco: ${document.getElementById('cod_univoco').value}`, 20, y); y+=5;
            } else {
                doc.text(`Cliente: ${document.getElementsByName('nome')[0].value}`, 20, y); y+=5;
                doc.text(`C.F.: ${document.getElementsByName('cf')[0].value}`, 20, y); y+=5;
            }
            doc.text(`Indirizzo: ${document.getElementById('ind_fatt').value}`, 20, y); y += 10;
            doc.setFontSize(14); doc.text("Dati Spedizione:", 20, y); y += 7;
            doc.setFontSize(10);
            doc.text(`Indirizzo Spedizione: ${document.getElementById('ind_sped').value}`, 20, y); y+=5;
            doc.text(`Telefono: ${document.getElementsByName('telefono')[0].value || "Non fornito"}`, 20, y);
            y += 15; doc.setFontSize(14); doc.text("Dettaglio Ricambi:", 20, y);
            y += 5; doc.line(20, y, 190, y); y += 8;
            let totaleRicambi = 0; doc.setFontSize(10);
            Object.keys(cart).forEach(id => {
                let p = prodotti[id]; let qty = cart[id]; let sub = p.prezzo * qty;
                totaleRicambi += sub;
                doc.text(`${p.nome} (x${qty})`, 20, y); doc.text(`${sub.toFixed(2)}‚Ç¨`, 170, y, { align: 'right' });
                y += 6;
            });
            y += 10; doc.line(120, y-5, 190, y-5);
            doc.text(`Imponibile Ricambi:`, 120, y); doc.text(`${totaleRicambi.toFixed(2)}‚Ç¨`, 190, y, { align: 'right' }); y += 6;
            let spedizione = (totaleRicambi >= 100) ? 0 : 7.50;
            doc.text(`Spese Spedizione:`, 120, y); doc.text(`${spedizione === 0 ? "GRATIS" : "7.50‚Ç¨"}`, 190, y, { align: 'right' }); y += 6;
            let contrassegno = document.getElementById('metodo_pag').value === "Contrassegno" ? 5 : 0;
            if(contrassegno > 0){
                doc.text(`Supplemento Contrassegno:`, 120, y); doc.text(`5.00‚Ç¨`, 190, y, { align: 'right' }); y += 6;
            }
            const totaleFin = (totaleRicambi + spedizione + contrassegno).toFixed(2);
            doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text(`TOTALE ORDINE:`, 120, y + 5); doc.text(`${totaleFin}‚Ç¨`, 190, y + 5, { align: 'right' });
            y += 20; doc.setFontSize(10); doc.setFont(undefined, 'normal');
            doc.text(`Metodo di Pagamento: ${document.getElementById('metodo_pag').value}`, 20, y);
            currentDoc = doc;
            const pdfBlobUrl = doc.output('bloburl');
            document.getElementById('pdf-preview').src = pdfBlobUrl + '#view=FitH';
            document.getElementById('modal-pdf').style.display = 'flex';
        }

        function modificaOrdine() { document.getElementById('modal-pdf').style.display = 'none'; }
        function downloadPDF() { if(currentDoc) currentDoc.save(`Ordine_${currentOrderNum}_CarsWorld.pdf`); }
        async function condividiPDF() {
            if (!currentDoc) return;
            const pdfBlob = currentDoc.output('blob');
            const file = new File([pdfBlob], `Riepilogo_Ordine_${currentOrderNum}.pdf`, { type: "application/pdf" });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try { await navigator.share({ files: [file], title: 'Ordine Car\'s World', text: `Ecco il riepilogo del mio ordine n. ${currentOrderNum}` }); } catch (err) { alert("Condivisione annullata."); }
            } else { alert("La condivisione non √® supportata su questo browser. Usa il tasto Download."); }
        }

        function chiudiEInvia() {
            cart = {}; saveCart();
            document.getElementById('modal-pdf').style.display = 'none';
            allowSubmit = true;
            document.getElementById('form-carrello').submit();
        }

        renderUI();
    </script>
</body>
</html>
