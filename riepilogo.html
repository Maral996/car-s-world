<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riepilogo - Car's world</title>
    
    <script src="prodotti.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; }
        .summary-box { width: 100%; max-width: 800px; background: white; padding: 25px; border-radius: 18px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); text-align: center; }
        h2 { color: #ff9800; margin-bottom: 20px; }
        #pdf-preview { width: 100%; height: 60vh; border: 1px solid #ddd; border-radius: 10px; background: white; margin-bottom: 20px; }
        .pdf-actions { display: flex; gap: 10px; width: 100%; justify-content: center; flex-wrap: wrap; }
        .btn { border: none; padding: 15px 25px; border-radius: 12px; font-weight: bold; cursor: pointer; color: white; font-size: 16px; flex: 1; max-width: 250px; transition: 0.3s; }
        .btn:disabled { background: #ccc !important; cursor: wait; }
        
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #ff9800; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p style="margin-top:15px; font-weight:bold; color:#ff9800;">Invio ordine in corso...</p>
</div>

<div class="summary-box">
    <h2 id="titolo-pagina">Anteprima del tuo Ordine</h2>
    <p id="istruzioni">Controlla i dettagli nel PDF prima di confermare l'invio.</p>
    
    <iframe id="pdf-preview"></iframe>

    <div class="pdf-actions" id="azioni">
        <button class="btn" style="background:#888;" onclick="history.back()">‚úèÔ∏è Modifica</button>
        <button class="btn" style="background:#4caf50;" onclick="downloadPDF()">‚¨áÔ∏è Download</button>
        <button id="btn-invia-finale" class="btn" style="background:#d32f2f;" onclick="inviaOrdineAJAX()">üöÄ INVIA ORDINE ORA</button>
    </div>
</div>

<script>
    // UTILIZZA IL DATABASE ESTERNO
    const prodotti = LISTA_PRODOTTI;
    const dati = JSON.parse(sessionStorage.getItem('dati_checkout'));
    let cart = JSON.parse(localStorage.getItem('cart_carsworld')) || {};
    
    let currentDoc = null;
    let payload = {}; 

    if (!dati) { window.location.href = 'checkout.html'; }

    function generateOrderNumber() {
        const anno = new Date().getFullYear();
        const caratteri = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let casuale = '';
        for (let i = 0; i < 6; i++) {
            casuale += caratteri.charAt(Math.floor(Math.random() * caratteri.length));
        }
        return `${anno}${casuale}`;
    }

    function generaPDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        const ora = new Date().toLocaleString('it-IT');
        const numOrdine = generateOrderNumber();
        
        doc.setFontSize(22); doc.setTextColor(255, 152, 0); 
        doc.text("Car's World - Store Ricambi", 20, 20);
        doc.setFontSize(10); doc.setTextColor(100);
        doc.text(`Ordine: ${numOrdine} | Data: ${ora}`, 20, 30);
        
        doc.setFontSize(12); doc.setTextColor(0);
        doc.text("DESTINATARIO:", 20, 45);
        let infoFatt = dati.tipo === 'Azienda' ? dati.rag_soc : dati.nome;
        doc.setFont(undefined, 'normal');
        doc.text(`${infoFatt}\n${dati.f_via}\n${dati.f_cap} ${dati.f_cit} (${dati.f_pro})`, 20, 52);

        let y = 80;
        doc.setFont(undefined, 'bold');
        doc.text("Dettaglio Ordine:", 20, y); y += 10;
        doc.setFontSize(10);
        
        let totRicambi = 0;
        let listaTesto = "";
        Object.keys(cart).forEach(id => {
            if(prodotti[id]) {
                let p = prodotti[id]; let qty = cart[id]; let sub = p.prezzo * qty;
                totRicambi += sub;
                // MODIFICA: Inserito codice ID nel PDF
                doc.text(`[${id}] ${p.nome} x${qty}`, 20, y); doc.text(`${sub.toFixed(2)}‚Ç¨`, 160, y);
                // MODIFICA: Inserito codice ID nella lista per e-mail
                listaTesto += `Cod: ${id} - ${p.nome} (x${qty}), `;
                y += 7;
            }
        });

        let spedVal = (totRicambi >= 100) ? 0 : 7.50;
        let contrVal = dati.pagamento === "Contrassegno" ? 5 : 0;
        let totaleFin = (totRicambi + spedVal + contrVal).toFixed(2);

        y += 10;
        doc.text(`Spedizione: ${spedVal === 0 ? "Gratis" : spedVal.toFixed(2) + "‚Ç¨"}`, 130, y); y += 7;
        doc.text(`Supplemento: ${contrVal.toFixed(2)}‚Ç¨`, 130, y); y += 10;
        doc.setFontSize(14); doc.text(`TOTALE: ${totaleFin}‚Ç¨`, 130, y);

        payload = {
            email: dati.email,
            telefono: dati.tel,
            cliente: infoFatt,
            indirizzo: `${dati.f_via}, ${dati.f_cit}`,
            pagamento: dati.pagamento,
            dettagli_ordine: `ORDINE ${numOrdine}: ${listaTesto} | TOTALE: ${totaleFin}‚Ç¨`
        };

        currentDoc = doc;
        document.getElementById('pdf-preview').src = doc.output('bloburl');
    }

    function downloadPDF() { if(currentDoc) currentDoc.save(`Ordine_CarsWorld.pdf`); }

    function inviaOrdineAJAX() {
        const loader = document.getElementById('loader');
        const btn = document.getElementById('btn-invia-finale');
        
        loader.style.display = 'flex';
        btn.disabled = true;

        const form = new FormData();
        for (const key in payload) {
            form.append(key, payload[key]);
        }

        fetch("https://formspree.io/f/mlgdkage", {
            method: "POST",
            body: form,
            headers: { 'Accept': 'application/json' }
        })
        .then(response => {
            loader.style.display = 'none';
            if (response.ok) {
                document.getElementById('titolo-pagina').innerText = "‚úÖ Ordine Inviato!";
                document.getElementById('titolo-pagina').style.color = "green";
                document.getElementById('istruzioni').innerText = "Verrai reindirizzato allo store, grazie per l'acquisto.";
                document.getElementById('azioni').style.display = "none";
                
                localStorage.removeItem('cart_carsworld');
                sessionStorage.removeItem('dati_checkout');

                setTimeout(() => {
                    window.location.href = "store.html";
                }, 4000);
            } else {
                alert("Errore nell'invio. Verifica la tua connessione.");
                btn.disabled = false;
            }
        })
        .catch(error => {
            loader.style.display = 'none';
            alert("Errore tecnico durante l'invio.");
            btn.disabled = false;
        });
    }

    window.onload = generaPDF;
</script>
</body>
</html>
