<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-out - Car's world</title>
    
    <script src="prodotti.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; }
        .checkout-box { width: 100%; max-width: 600px; background: white; padding: 30px; border-radius: 18px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); text-align: center; box-sizing: border-box; }
        h2 { color: #0c83eb; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-top: 0; }
        h3 { font-size: 16px; text-transform: uppercase; color: #555; margin-top: 25px; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #ddd; font-size: 15px; outline: none; box-sizing: border-box; text-align: center; font-family: inherit; }
        .address-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; }
        
        .riepilogo-box { background: #f0f7ff; padding: 20px; border-radius: 12px; border: 1px solid #0c83eb; margin-top: 25px; margin-bottom: 15px; }
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; color: #444; font-size: 15px; }
        .totale-grande { display: flex; justify-content: space-between; font-weight: 800; font-size: 22px; color: #0c83eb; border-top: 2px solid #0c83eb; padding-top: 15px; margin-top: 10px; }
        
        .btn-procedi { background: #0c83eb; color: white; border: none; width: 100%; padding: 18px; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 17px; margin-top: 10px; }
        .hidden { display: none !important; }
        .checkbox-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px; font-size: 14px; color: #555; cursor: pointer; }
        .checkbox-container input { width: auto; margin: 0; }
        @media (max-width: 480px) { .address-grid { grid-template-columns: 1fr; gap: 0; } }
    </style>
</head>
<body>

<div class="checkout-box">
    <a href="store.html" style="text-decoration:none; color:#888; font-size: 14px; display: block; margin-bottom: 10px;">← Torna allo store</a>
    <h2>Dati di Spedizione</h2>

    <form id="form-dati" onsubmit="procediAlRiepilogo(event)">
        <h3>Contatti</h3>
        <input type="email" id="email" placeholder="Indirizzo Email">
        <input type="tel" id="tel" placeholder="Numero di Telefono / WhatsApp">
        <small style="color: #888; display: block; margin-top: -10px; margin-bottom: 15px;">* Inserisci almeno un recapito</small>

        <h3>Dati Fatturazione</h3>
        <select id="tipo_cliente" onchange="switchFatt()">
            <option value="Privato">Privato</option>
            <option value="Azienda">Azienda</option>
        </select>
        <div id="box-privato">
            <input type="text" id="nome" placeholder="Nome e Cognome" required>
            <input type="text" id="cf" placeholder="Codice Fiscale" oninput="this.value = this.value.toUpperCase()" required>
        </div>
        <div id="box-ditta" class="hidden">
            <input type="text" id="ragione_sociale" placeholder="Ragione Sociale">
            <input type="text" id="piva" placeholder="Partita IVA">
            <input type="text" id="cod_univoco" placeholder="Codice Univoco o PEC">
        </div>
        
        <input type="text" id="fatt_via" placeholder="Indirizzo" required>
        <div class="address-grid">
            <input type="text" id="fatt_citta" placeholder="Città" required>
            <input type="text" id="fatt_prov" placeholder="Prov." maxlength="2" oninput="this.value = this.value.toUpperCase()" required>
            <input type="text" id="fatt_cap" placeholder="CAP" maxlength="5" required>
        </div>

        <h3>Spedizione</h3>
        <label class="checkbox-container">
            <input type="checkbox" id="check_spedizione_diversa" onchange="toggleSpedizione()">
            Indirizzo di spedizione diverso da quello di fatturazione?
        </label>
        
        <div id="box-spedizione" class="hidden">
            <input type="text" id="sped_nome" placeholder="Nome sul citofono">
            <input type="text" id="sped_via" placeholder="Indirizzo Spedizione">
            <div class="address-grid">
                <input type="text" id="sped_citta" placeholder="Città">
                <input type="text" id="sped_prov" placeholder="Prov." maxlength="2" oninput="this.value = this.value.toUpperCase()">
                <input type="text" id="sped_cap" placeholder="CAP" maxlength="5">
            </div>
            <input type="tel" id="sped_tel" placeholder="Telefono per il corriere (se diverso)">
        </div>

        <textarea id="note" placeholder="Note per il corriere (es: interno, scala, orari)" rows="3"></textarea>

        <h3>Metodo di Pagamento</h3>
        <select id="metodo_pag" onchange="calcolaImporti()">
            <option value="Bonifico">Bonifico Bancario</option>
            <option value="Contrassegno">Contrassegno (+5.00€)</option>
        </select>

        <div class="riepilogo-box">
            <div class="row"><span>Prodotti:</span><span id="res-ric">0.00€</span></div>
            <div id="row-pfu" class="row hidden"><span style="font-style: italic;">Contributo Ambientale PFU:</span><span id="res-pfu">0.00€</span></div>
            <div id="row-contributo" class="row hidden"><span style="font-style: italic;">Contributo Eco Ambientale:</span><span id="res-contributo">0.00€</span></div>
            <div class="row"><span>Spedizione:</span><span id="res-sped">0.00€</span></div>
            <div id="row-contrassegno" class="row hidden"><span>Supplemento Contrassegno:</span><span>5.00€</span></div>
            <div class="totale-grande"><span>TOTALE:</span><span id="res-tot">0.00€</span></div>
        </div>

        <button type="submit" class="btn-procedi">VAI AL RIEPILOGO PDF →</button>
    </form>
</div>

<script>
    const prodotti = LISTA_PRODOTTI;

    function calcolaImporti() {
        let cart = JSON.parse(localStorage.getItem('cart_carsworld')) || {};
        let ric = 0;
        let pfu = 0;
        let contributo = 0;
        const COSTO_PFU_SINGOLO = 2.50;
        const COSTO_CONTRIBUTO_SINGOLO = 4.00;

        Object.keys(cart).forEach(id => { 
            if(prodotti[id]) {
                ric += prodotti[id].prezzo * cart[id];
                
                if(prodotti[id].isPneumatico) {
                    pfu += (COSTO_PFU_SINGOLO * cart[id]);
                }
                if(prodotti[id].isBatteria) {
                    contributo += (COSTO_CONTRIBUTO_SINGOLO * cart[id]);
                }
            }
        });

        let sped = (ric >= 100 || ric === 0) ? 0 : 7.50;
        let isContr = document.getElementById('metodo_pag').value === "Contrassegno";
        let contr = isContr ? 5 : 0;

        document.getElementById('row-contrassegno').classList.toggle('hidden', !isContr);
        document.getElementById('row-pfu').classList.toggle('hidden', pfu === 0);
        document.getElementById('row-contributo').classList.toggle('hidden', contributo === 0);

        document.getElementById('res-ric').innerText = ric.toFixed(2) + "€";
        document.getElementById('res-pfu').innerText = pfu.toFixed(2) + "€";
        document.getElementById('res-contributo').innerText = contributo.toFixed(2) + "€";
        document.getElementById('res-sped').innerText = sped === 0 ? "Gratis" : "7.50€";
        
        let totaleFinale = ric + pfu + contributo + sped + contr;
        document.getElementById('res-tot').innerText = totaleFinale.toFixed(2) + "€";
    }

    function switchFatt() {
        const isDitta = document.getElementById('tipo_cliente').value === 'Azienda';
        document.getElementById('box-privato').classList.toggle('hidden', isDitta);
        document.getElementById('box-ditta').classList.toggle('hidden', !isDitta);
        document.getElementById('nome').required = !isDitta;
        document.getElementById('cf').required = !isDitta;
        document.querySelector('#box-ditta input[id="ragione_sociale"]').required = isDitta;
        document.querySelector('#box-ditta input[id="piva"]').required = isDitta;
    }

    function toggleSpedizione() {
        const diversa = document.getElementById('check_spedizione_diversa').checked;
        document.getElementById('box-spedizione').classList.toggle('hidden', !diversa);
    }

    function procediAlRiepilogo(e) {
        e.preventDefault();
        const emailVal = document.getElementById('email').value.trim();
        const telVal = document.getElementById('tel').value.trim();

        if (emailVal === "" && telVal === "") {
            alert("Per favore, inserisci almeno un metodo di contatto per procedere.");
            return;
        }

        const dati = {
            email: emailVal,
            tel: telVal,
            tipo: document.getElementById('tipo_cliente').value,
            nome: document.getElementById('nome').value,
            cf: document.getElementById('cf').value,
            rag_soc: document.getElementById('ragione_sociale').value,
            piva: document.getElementById('piva').value,
            univoco: document.getElementById('cod_univoco').value,
            f_via: document.getElementById('fatt_via').value,
            f_cit: document.getElementById('fatt_citta').value,
            f_pro: document.getElementById('fatt_prov').value,
            f_cap: document.getElementById('fatt_cap').value,
            spedizione_uguale: !document.getElementById('check_spedizione_diversa').checked,
            s_nome: document.getElementById('sped_nome').value,
            s_via: document.getElementById('sped_via').value,
            s_cit: document.getElementById('sped_citta').value,
            s_pro: document.getElementById('sped_prov').value,
            s_cap: document.getElementById('sped_cap').value,
            s_tel: document.getElementById('sped_tel').value,
            note: document.getElementById('note').value,
            pagamento: document.getElementById('metodo_pag').value
        };
        
        sessionStorage.setItem('dati_checkout', JSON.stringify(dati));
        window.location.href = 'riepilogo.html';
    }

    window.onload = calcolaImporti;
</script>
</body>
</html>
